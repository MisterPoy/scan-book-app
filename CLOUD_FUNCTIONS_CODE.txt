// CODE Ã€ COPIER DANS functions/index.js

const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();

/**
 * Sync Firebase Auth â†’ Firestore lors de la CRÃ‰ATION d'un utilisateur
 * Se dÃ©clenche automatiquement Ã  chaque inscription
 */
exports.syncUserProfileOnCreate = functions.auth.user().onCreate(async (user) => {
  const userProfile = {
    uid: user.uid,
    email: user.email || null,
    displayName: user.displayName || null,
    photoURL: user.photoURL || null,
    emailVerified: user.emailVerified,
    createdAt: user.metadata.creationTime,
    lastLoginAt: user.metadata.lastSignInTime || user.metadata.creationTime,
    providerData: user.providerData.map((p) => ({
      providerId: p.providerId,
      email: p.email || null,
    })),
    disabled: user.disabled || false,
    isAdmin: false, // Par dÃ©faut, pas admin
  };

  await admin.firestore()
    .collection("user_profiles")
    .doc(user.uid)
    .set(userProfile);

  console.log(`âœ… User profile created for: ${user.email || user.uid}`);
});

/**
 * Sync Firebase Auth â†’ Firestore lors de la SUPPRESSION d'un utilisateur
 * Nettoie les donnÃ©es Firestore quand un compte est supprimÃ©
 */
exports.syncUserProfileOnDelete = functions.auth.user().onDelete(async (user) => {
  await admin.firestore()
    .collection("user_profiles")
    .doc(user.uid)
    .delete();

  console.log(`ğŸ—‘ï¸ User profile deleted for: ${user.email || user.uid}`);
});
