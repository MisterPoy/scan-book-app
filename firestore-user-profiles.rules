// Règles Firestore pour la collection user_profiles
// À déployer dans la console Firebase (fusionner avec les règles existantes)

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Collection user_profiles - Métadonnées utilisateurs
    // IMPORTANT: Cette collection doit être créée et maintenue par une Cloud Function
    // qui sync Firebase Auth → Firestore lors de la création/connexion d'un utilisateur
    match /user_profiles/{userId} {
      // Lecture: Uniquement les admins peuvent lire tous les profils
      allow read: if request.auth != null &&
                     get(/databases/$(database)/documents/user_profiles/$(request.auth.uid)).data.isAdmin == true;

      // Écriture: Seul le propriétaire peut mettre à jour son propre profil (champs limités)
      // OU les admins peuvent tout modifier
      allow update: if (request.auth != null && request.auth.uid == userId &&
                       // L'utilisateur ne peut modifier que certains champs
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'photoURL'])) ||
                      (request.auth != null &&
                       get(/databases/$(database)/documents/user_profiles/$(request.auth.uid)).data.isAdmin == true);

      // Création: Seulement via Cloud Function (pas d'accès direct)
      allow create: if false;

      // Suppression: Seulement les admins
      allow delete: if request.auth != null &&
                       get(/databases/$(database)/documents/user_profiles/$(request.auth.uid)).data.isAdmin == true;
    }

    // Collection users/{uid}/collection - Livres de l'utilisateur (existant)
    match /users/{uid}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
  }
}
